\section{条件数学期望}



    \begin{definition}
        设随机变量$X$在$y=y_i$的条件下的条件分布列为
        $$
        p_{i|j}=P(X=x_i | Y=y_j),
        $$
        若级数$\sum_i x_i p_{i|j}$绝对收敛, 那么称此级数$Y=Y_i$条件下$X$的条件数学期望, 记为$\Ep{X|Y=y_i}$.
    \end{definition}

    正如条件概率也是概率, 条件数学期望也是数学期望. 自然, 它就满足数学期望对应的性质. 

    \begin{example}
        有一根长度为$l$的棍子, 在$(0,l)$内均匀地取一点$X$折断. 再次在$(0,a)$选一点$Y$折断. 求$Y$的期望. 
    \end{example}

    \begin{solution}
        假设$Y$是一个具体值的情形. $\Ep{X \mid Y=y}=\frac{y}{2}$是一个数字. 但是实验之前, 这个值是随机的. 我们干脆把它写作$\Ep{X|Y}$作为一个随机变量. 其中, 记作$\Ep{X|Y}=Y/2$.
    \end{solution}



    下面来看有时候如何方便地计算期望. 我们可以把样本空间构成一组不相交的集合$A_1, A_2, \cdots, A_n$, 因此可以在每个小块上面计算期望值. 也就是: $$
    \Ep{X}=P\left(A_1\right) \Ep{X \mid A_1}+\cdots+P\left(A_n\right) \Ep{X \mid A_n} .
    $$
    这个可以使用全概率公式, 两边乘上其对应的系数得到. 这就是\textbf{全期望公式}. 


    有了这样的记号, 我们给出指数分布的期望的又一说明: 
    \begin{example}
        
    我们把原来的事件划分为不相交的两类. 
    $$
    \begin{aligned}
    & A_1:\{x=1\}, \quad A_2:\{x>1\} . \\
    & \Ep{X}=P(X=1) \Ep{X \mid x=1}+P(X>1) \Ep{X \mid x>1} .
    \end{aligned}
    $$
    那么计算它就得到了: 
    $$
\begin{aligned}
\Ep{X} & =P(X=1) E[X \mid x=1]+P(X>1) E[X \mid x>1] . \\
& =p \cdot 1+(1-p)\boxed{~~?~~}
\end{aligned}
$$
我们关注$E[X \mid x>1]$的情形, $$
\begin{aligned}
E[X \mid x-1>0] & =E[X-1 \mid x-1>0]+1 \\
& =\Ep{X}+1
\end{aligned}
$$
由于指数分布的无记忆性, 上面的式子就是$\Ep{X}+1$. 

上面的式子经过整理得到$\Ep{X}=p \cdot 1+(1-p)(\Ep{X}+1)$. 我们由此解答出来$\Ep{X}$, 因此就得到期望值为$1/p$. 

    \end{example}

    \subsection{迭代的期望}

    我们接下来考虑期望的迭代公式, 也就是$\mathbb{E}[\mathbb{E}[X \mid Y]]$. 这个符号看上去很难懂. 我们先从简单来看这个公式: 
    \begin{itemize}
        \item $\mathbb{E}[X \mid Y=y]$表示当随机变量$Y$取值$y$的时候, 随机变量$X$的期望. 
        \item 考虑所有可能的$Y$, 其构成的一组期望就是$\mathbb{E}_y[X \mid Y=y], \forall y$. 
        \item 这一组期望, 是一个关于$Y$的随机变量.为了简便,我们把这样的一组简写为$\mathbb{E}[X \mid Y]$.
        \item 对于这样的一个随机变量, 自然可以求它的期望. 
    \end{itemize}

    实际上, 这个公式有一个更简洁的表示. 我们按照定义展开: 
    $$\begin{aligned} \text{左手边} & =\int_{-\infty}^{+\infty}\left(\int_{-\infty}^{+\infty} \frac{f_{x, Y}(x, y)}{f_Y(y)} d x\right) f_Y(y) d y \\ & =\int_{-\infty}^{+\infty} \int_{-\infty}^{+\infty} x f_{X, Y}(x, y) d x d y . \\ & =\int_{-\infty}^{+\infty} x f_x(x) d x=\mathbb{E}[x]=\text{右手边}\end{aligned}$$

    这个公式有一个名字, 叫做``迭代期望定律(Law of iterated expectations)''. 

    \begin{theorem}
        迭代的期望公式:$$
\mathbb{E}[{\mathbb{E}}[X \mid Y]]=\mathbb{E}[X]
$$
    \end{theorem}

